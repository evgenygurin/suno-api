# CircleCI 2.1 Configuration for Suno API
#
# This configuration provides CI/CD automation including:
# - Code quality checks (linting, type checking)
# - Security scanning (npm audit, GitGuardian secret detection)
# - Automated builds
# - Sentry release tracking
# - Codegen AI-powered reviews
#
# Documentation: https://circleci.com/docs/

version: 2.1

# Orbs - reusable packages of configuration
orbs:
  node: circleci/node@6.3.0
  ggshield: gitguardian/ggshield@1.1.4
  sentry: sentry/sentry-cli@2.0.0

# Executors - execution environments
executors:
  node-executor:
    docker:
      - image: cimg/node:20.18
    working_directory: ~/project
    environment:
      NODE_ENV: test

# Reusable commands
commands:
  install-dependencies:
    description: "Install npm dependencies with caching"
    steps:
      - restore_cache:
          name: Restore npm cache
          keys:
            - v1-dependencies-{{ checksum "package-lock.json" }}
            - v1-dependencies-

      - run:
          name: Install dependencies
          command: npm ci

      - save_cache:
          name: Save npm cache
          key: v1-dependencies-{{ checksum "package-lock.json" }}
          paths:
            - ~/.npm
            - node_modules

# Jobs - individual units of work
jobs:
  # Job 1: Code quality checks
  quality-checks:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies

      - run:
          name: Run ESLint
          command: npm run lint

      - run:
          name: Type checking
          command: npx tsc --noEmit

  # Job 2: Security scanning
  security-scan:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies

      - run:
          name: npm audit
          command: |
            npm audit --audit-level=moderate || true
            echo "✅ Security scan completed"

  # Job 3: Build
  build:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies

      - run:
          name: Build Next.js application
          command: npm run build

      - persist_to_workspace:
          root: .
          paths:
            - .next
            - node_modules

      - store_artifacts:
          path: .next
          destination: build

  # Job 4: Codegen AI Review
  codegen-review:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies

      - run:
          name: Install Codegen CLI
          command: pip install codegen-ai

      - run:
          name: Run Codegen AI Review
          command: |
            if [ -n "$CODEGEN_API_KEY" ]; then
              echo "Running Codegen AI code review..."
              codegen claude "Review the recent changes in this repository. Focus on code quality, potential bugs, and best practices." \
                --org-id "${CODEGEN_ORG_ID}" || true
              echo "✅ Codegen review completed"
            else
              echo "⚠️  CODEGEN_API_KEY not set, skipping AI review"
            fi

  # Job 5: Sentry Release Tracking
  sentry-release:
    executor: node-executor
    steps:
      - checkout
      - install-dependencies

      - run:
          name: Create Sentry Release
          command: |
            if [ -n "$SENTRY_AUTH_TOKEN" ]; then
              # Install Sentry CLI
              curl -sL https://sentry.io/get-cli/ | bash

              # Set release version to git SHA
              export SENTRY_RELEASE="${CIRCLE_SHA1}"
              export SENTRY_ORG="${SENTRY_ORG:-laptop-dev}"
              export SENTRY_PROJECT="${SENTRY_PROJECT:-suno-api}"

              echo "Creating Sentry release: $SENTRY_RELEASE"

              # Create new release
              sentry-cli releases new "$SENTRY_RELEASE" \
                --org "$SENTRY_ORG" \
                --project "$SENTRY_PROJECT"

              # Associate commits
              sentry-cli releases set-commits "$SENTRY_RELEASE" \
                --org "$SENTRY_ORG" \
                --auto

              # Upload source maps (Next.js build artifacts)
              if [ -d ".next" ]; then
                echo "Uploading source maps..."
                sentry-cli sourcemaps upload \
                  --org "$SENTRY_ORG" \
                  --project "$SENTRY_PROJECT" \
                  --release "$SENTRY_RELEASE" \
                  .next/static
              fi

              # Finalize release
              sentry-cli releases finalize "$SENTRY_RELEASE" \
                --org "$SENTRY_ORG" \
                --project "$SENTRY_PROJECT"

              # Create deployment
              sentry-cli releases deploys "$SENTRY_RELEASE" new \
                --env "${SENTRY_ENVIRONMENT:-production}" \
                --org "$SENTRY_ORG"

              echo "✅ Sentry release tracking completed"
            else
              echo "⚠️  SENTRY_AUTH_TOKEN not set, skipping release tracking"
            fi

# Workflows - orchestrate jobs
workflows:
  version: 2

  # Main workflow for all branches
  build-and-test:
    jobs:
      - ggshield/scan:
          name: ggshield-scan
          base_revision: << pipeline.git.base_revision >>
          revision: << pipeline.git.revision >>
      - quality-checks
      - security-scan
      - codegen-review:
          context: codegen
      - build:
          requires:
            - ggshield-scan
            - quality-checks
            - security-scan
      - sentry-release:
          context: sentry
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - master
