version: 2.1

orbs:
  node: circleci/node@6.1.0
  slack: circleci/slack@4.13.3
  browser-tools: circleci/browser-tools@1.4.8

# Parameters for dynamic configuration
parameters:
  run-integration-tests:
    type: boolean
    default: false
  deploy-environment:
    type: string
    default: "staging"

executors:
  node-executor:
    docker:
      - image: cimg/node:20.11.1
    resource_class: medium
    working_directory: ~/suno-api
    environment:
      NODE_ENV: production
      CI: true

  node-browsers-executor:
    docker:
      - image: cimg/node:20.11.1-browsers
    resource_class: large
    working_directory: ~/suno-api
    environment:
      NODE_ENV: test
      CI: true

commands:
  restore-workspace:
    steps:
      - attach_workspace:
          at: ~/suno-api

  notify-on-failure:
    steps:
      - slack/notify:
          event: fail
          template: basic_fail_1

  notify-on-success:
    steps:
      - slack/notify:
          event: pass
          template: success_tagged_deploy_1

jobs:
  install-and-cache:
    executor: node-executor
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          cache-path: ~/.npm
          override-ci-command: npm ci
      - persist_to_workspace:
          root: ~/suno-api
          paths:
            - .

  type-check:
    executor: node-executor
    steps:
      - restore-workspace
      - run:
          name: TypeScript Type Checking
          command: npx tsc --noEmit

  lint:
    executor: node-executor
    steps:
      - restore-workspace
      - run:
          name: Run ESLint
          command: npm run lint

  security-audit:
    executor: node-executor
    steps:
      - restore-workspace
      - run:
          name: npm Security Audit
          command: npm audit --audit-level=moderate || true

  build:
    executor: node-executor
    steps:
      - restore-workspace
      - run:
          name: Build Next.js Application
          command: npm run build
      - run:
          name: Verify Build Artifacts
          command: |
            if [ ! -d ".next" ]; then
              echo "Error: .next directory not found"
              exit 1
            fi
            echo "‚úÖ Build artifacts verified successfully"
      - store_artifacts:
          path: .next
          destination: build-artifacts
      - persist_to_workspace:
          root: ~/suno-api
          paths:
            - .next
            - node_modules
            - .

  integration-tests:
    executor: node-browsers-executor
    when: << pipeline.parameters.run-integration-tests >>
    steps:
      - restore-workspace
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - run:
          name: Install Playwright Browsers
          command: npx playwright install chromium
      - run:
          name: Run Integration Tests
          command: |
            echo "‚ö†Ô∏è Integration tests not yet implemented"
            echo "Future: Will test CAPTCHA solving and music generation flows"
          no_output_timeout: 10m
      - store_test_results:
          path: test-results
      - store_artifacts:
          path: test-results
          destination: integration-test-results

  performance-audit:
    executor: node-executor
    steps:
      - restore-workspace
      - run:
          name: Analyze Bundle Size
          command: |
            npm run build
            echo "üìä Analyzing bundle size..."
            du -sh .next/static || true
      - store_artifacts:
          path: .next/analyze
          destination: bundle-analysis

  sentry-release:
    executor: node-executor
    steps:
      - restore-workspace
      - run:
          name: Install Sentry CLI
          command: |
            curl -sL https://sentry.io/get-cli/ | bash
            sentry-cli --version
      - run:
          name: Verify Sentry Configuration
          command: |
            # Verify .sentryrc exists or environment variables are set
            if [ ! -f ".sentryrc" ] && [ -z "$SENTRY_AUTH_TOKEN" ]; then
              echo "‚ùå Error: Sentry not configured"
              echo "Either .sentryrc file or SENTRY_AUTH_TOKEN environment variable required"
              exit 1
            fi

            if [ -f ".sentryrc" ]; then
              echo "‚úÖ Using .sentryrc configuration"
            else
              echo "‚úÖ Using environment variables"
            fi

            # Verify we have the required variables
            if [ -z "$SENTRY_ORG" ] || [ -z "$SENTRY_PROJECT" ]; then
              echo "‚ùå Error: SENTRY_ORG and SENTRY_PROJECT must be set"
              exit 1
            fi
      - run:
          name: Create Sentry Release
          command: |
            # Use git tag if available, otherwise use short commit SHA
            if [ -n "$CIRCLE_TAG" ]; then
              export SENTRY_RELEASE="$CIRCLE_TAG"
            else
              export SENTRY_RELEASE="${CIRCLE_SHA1:0:7}"
            fi

            echo "üì¶ Creating Sentry release: ${SENTRY_RELEASE}"
            echo "   Organization: ${SENTRY_ORG}"
            echo "   Project: ${SENTRY_PROJECT}"

            # Create new release
            sentry-cli releases new "${SENTRY_RELEASE}" \
              --project "${SENTRY_PROJECT}"

            # Associate commits with release
            echo "üîó Linking commits to release..."
            sentry-cli releases set-commits "${SENTRY_RELEASE}" --auto \
              || echo "‚ö†Ô∏è Could not link commits (non-fatal)"
      - run:
          name: Upload Source Maps to Sentry
          command: |
            export SENTRY_RELEASE="${CIRCLE_TAG:-${CIRCLE_SHA1:0:7}}"

            if [ -d ".next" ]; then
              echo "üì§ Uploading source maps for better error tracking..."

              # Upload source maps from .next/static
              sentry-cli releases files "${SENTRY_RELEASE}" \
                upload-sourcemaps .next/static \
                --url-prefix "~/_next/static" \
                --rewrite \
                || echo "‚ö†Ô∏è Source map upload failed (non-fatal)"

              echo "‚úÖ Source maps uploaded successfully"
            else
              echo "‚ö†Ô∏è .next directory not found, skipping source maps"
            fi
      - run:
          name: Finalize Sentry Release
          command: |
            export SENTRY_RELEASE="${CIRCLE_TAG:-${CIRCLE_SHA1:0:7}}"

            # Finalize the release
            echo "üèÅ Finalizing release..."
            sentry-cli releases finalize "${SENTRY_RELEASE}"

            # Determine deployment environment
            export DEPLOY_ENV="staging"
            if [ "${CIRCLE_BRANCH}" = "main" ]; then
              DEPLOY_ENV="production"
            elif [ -n "$CIRCLE_TAG" ]; then
              DEPLOY_ENV="production"
            fi

            # Create deployment marker
            echo "üöÄ Creating deployment marker for ${DEPLOY_ENV}..."
            sentry-cli releases deploys "${SENTRY_RELEASE}" new \
              --env "${DEPLOY_ENV}" \
              --name "CircleCI Deployment #${CIRCLE_BUILD_NUM}" \
              --url "${CIRCLE_BUILD_URL}"

            echo "‚úÖ Sentry release ${SENTRY_RELEASE} created and deployed to ${DEPLOY_ENV}"
            echo "üîó View in Sentry: https://sentry.io/organizations/${SENTRY_ORG}/releases/${SENTRY_RELEASE}/"
      - notify-on-failure

  codegen-review:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Setup Python for Codegen
          command: |
            sudo apt-get update
            sudo apt-get install -y python3-pip
      - run:
          name: Install Codegen SDK
          command: pip3 install codegen
      - run:
          name: Run Codegen Code Review
          command: |
            echo "ü§ñ Running Codegen code review..."
            python3 - <<'EOF'
            import os
            import sys

            # Check if Codegen is configured
            org_id = os.getenv('CODEGEN_ORG_ID')
            api_token = os.getenv('CODEGEN_API_TOKEN')

            if not all([org_id, api_token]):
                print("‚ö†Ô∏è  Codegen not configured. Skipping review.")
                print("‚ÑπÔ∏è  To enable: Add CODEGEN_ORG_ID and CODEGEN_API_TOKEN to CircleCI context")
                sys.exit(0)

            print("‚úÖ Codegen configured. Review functionality ready.")
            print("üìù For PR reviews, configure GitHub Actions workflow")
            EOF

workflows:
  version: 2

  # Main CI/CD workflow for all branches
  build-test-deploy:
    jobs:
      - install-and-cache:
          filters:
            branches:
              only:
                - main
                - develop
                - /feature\/.*/

      # Parallel quality checks
      - type-check:
          requires:
            - install-and-cache

      - lint:
          requires:
            - install-and-cache

      - security-audit:
          requires:
            - install-and-cache

      # Build after all checks pass
      - build:
          requires:
            - type-check
            - lint
            - security-audit

      # Optional: Performance audit
      - performance-audit:
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - develop

      # Optional: Integration tests (controlled by parameter)
      - integration-tests:
          requires:
            - build
          filters:
            branches:
              only:
                - main
                - develop

      # Optional: Codegen review
      - codegen-review:
          requires:
            - build
          context:
            - codegen
          filters:
            branches:
              only:
                - main
                - develop

      # Sentry release only for main branch
      - sentry-release:
          requires:
            - build
          context:
            - sentry
          filters:
            branches:
              only: main
          post-steps:
            - notify-on-success

  # Nightly workflow for comprehensive testing
  nightly:
    triggers:
      - schedule:
          cron: "0 2 * * *"  # Run at 2 AM UTC
          filters:
            branches:
              only:
                - main
    jobs:
      - install-and-cache
      - type-check:
          requires:
            - install-and-cache
      - lint:
          requires:
            - install-and-cache
      - security-audit:
          requires:
            - install-and-cache
      - build:
          requires:
            - type-check
            - lint
            - security-audit
      - integration-tests:
          requires:
            - build
      - performance-audit:
          requires:
            - build
