name: CI/CD with Codegen

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  # Run tests and build
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Build project
        run: npm run build

  # Codegen AI-powered code review (only on PRs)
  # This job is optional and won't block PR merge if it fails
  codegen-review:
    needs: test
    if: github.event_name == 'pull_request' && !cancelled()
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Codegen SDK
        run: pip install codegen

      - name: Run Codegen PR Review
        env:
          CODEGEN_ORG_ID: ${{ secrets.CODEGEN_ORG_ID }}
          CODEGEN_API_TOKEN: ${{ secrets.CODEGEN_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          python - <<'EOF'
          import os
          import sys
          import time
          import json
          from codegen.agents.agent import Agent

          def main():
              org_id = os.getenv('CODEGEN_ORG_ID')
              api_token = os.getenv('CODEGEN_API_TOKEN')
              pr_number = os.getenv('PR_NUMBER')
              repo_name = os.getenv('REPO_NAME')
              
              if not all([org_id, api_token]):
                  print("‚ö†Ô∏è  Codegen credentials not configured. Skipping review.")
                  print("‚ÑπÔ∏è  To enable Codegen reviews, add CODEGEN_ORG_ID and CODEGEN_API_TOKEN secrets to the repository.")
                  sys.exit(0)
              
              if not all([pr_number, repo_name]):
                  print("‚ùå Missing required environment variables")
                  sys.exit(1)
              
              print(f"üîç Starting Codegen review for PR #{pr_number} in {repo_name}")
              
              # Initialize Codegen agent
              agent = Agent(org_id=org_id, token=api_token)
              
              # Create review prompt
              prompt = f"""
              Please review PR #{pr_number} in repository {repo_name}.
              
              Focus on:
              - Code quality and TypeScript best practices
              - Next.js App Router patterns
              - Browser automation (Playwright) security and reliability
              - Error handling and logging (Pino)
              - CAPTCHA solving integration
              - Performance and rate limiting considerations
              - Security issues (especially cookie handling and API keys)
              - Documentation and code comments
              
              Follow the guidelines in CLAUDE.md for this project.
              Provide specific, actionable feedback with line numbers where appropriate.
              """
              
              try:
                  task = agent.run(prompt=prompt)
                  
                  # Wait for completion (max 5 minutes)
                  max_attempts = 30
                  attempt = 0
                  
                  while attempt < max_attempts:
                      task.refresh()
                      print(f"Status: {task.status} (attempt {attempt + 1}/{max_attempts})")
                      
                      if task.status == "completed":
                          print("‚úÖ Review completed successfully!")
                          if hasattr(task, 'result') and task.result:
                              print(f"\nüìä Result:\n{task.result}")
                          if hasattr(task, 'web_url'):
                              print(f"\nüîó View details: {task.web_url}")
                          break
                      elif task.status == "failed":
                          print("‚ùå Review failed")
                          if hasattr(task, 'result'):
                              print(f"Error: {task.result}")
                          sys.exit(1)
                      
                      attempt += 1
                      time.sleep(10)
                  
                  if attempt >= max_attempts:
                      print("‚è∞ Review timed out after 5 minutes")
                      sys.exit(1)
                      
              except Exception as e:
                  print(f"‚ùå Error running Codegen review: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

