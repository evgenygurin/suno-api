name: CI/CD Pipeline

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Run tests and build
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: false

      - name: Type check
        run: npx tsc --noEmit
        continue-on-error: false

      - name: Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true  # Don't fail on audit warnings

      - name: Build project
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next
          retention-days: 7

  # Codegen AI-powered code review (only on PRs)
  # This job is optional and won't block PR merge if it fails
  codegen-review:
    name: Codegen AI Review
    needs: test
    if: |
      github.event_name == 'pull_request' &&
      !contains(github.event.pull_request.labels.*.name, 'skip-review') &&
      github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      pull-requests: write
      contents: read
      issues: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Codegen SDK
        run: pip install codegen

      - name: Run Codegen PR Review
        env:
          CODEGEN_ORG_ID: ${{ secrets.CODEGEN_ORG_ID }}
          CODEGEN_API_TOKEN: ${{ secrets.CODEGEN_API_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BRANCH: ${{ github.head_ref }}
          BASE_BRANCH: ${{ github.base_ref }}
        run: |
          python - <<'EOF'
          import os
          import sys
          import time
          import json
          import logging
          from codegen.agents.agent import Agent

          # Configure logging
          logging.basicConfig(
              level=logging.INFO if not os.getenv('CODEGEN_DEBUG') else logging.DEBUG,
              format='%(asctime)s - %(levelname)s - %(message)s'
          )
          logger = logging.getLogger(__name__)

          def main():
              org_id = os.getenv('CODEGEN_ORG_ID')
              api_token = os.getenv('CODEGEN_API_TOKEN')
              pr_number = os.getenv('PR_NUMBER')
              repo_name = os.getenv('REPO_NAME')
              pr_title = os.getenv('PR_TITLE', '')
              pr_branch = os.getenv('PR_BRANCH', '')
              base_branch = os.getenv('BASE_BRANCH', '')

              if not all([org_id, api_token]):
                  logger.warning("‚ö†Ô∏è  Codegen credentials not configured. Skipping review.")
                  logger.info("‚ÑπÔ∏è  To enable: Add CODEGEN_ORG_ID and CODEGEN_API_TOKEN secrets")
                  sys.exit(0)

              if not all([pr_number, repo_name]):
                  logger.error("‚ùå Missing required environment variables")
                  sys.exit(1)

              logger.info(f"üîç Starting Codegen review for PR #{pr_number} in {repo_name}")
              logger.info(f"üìù Title: {pr_title}")
              logger.info(f"üåø Branch: {pr_branch} -> {base_branch}")

              # Initialize Codegen agent
              try:
                  agent = Agent(org_id=org_id, token=api_token)
              except Exception as e:
                  logger.error(f"Failed to initialize Codegen agent: {e}")
                  sys.exit(1)

              # Create comprehensive review prompt
              prompt = f"""
              Please review PR #{pr_number} in repository {repo_name}.

              **PR Details:**
              - Title: {pr_title}
              - Branch: {pr_branch} -> {base_branch}

              **Review Focus Areas:**

              1. **Code Quality & Best Practices**
                 - TypeScript strict mode compliance
                 - Next.js 14 App Router patterns
                 - React 18 functional components & hooks
                 - Proper async/await usage

              2. **Browser Automation (Playwright)**
                 - Security best practices
                 - Proper error handling for browser operations
                 - Timeout management
                 - Anti-detection measures (rebrowser-patches)

              3. **CAPTCHA Integration**
                 - 2Captcha API integration correctness
                 - Error handling for failed solves
                 - Cost optimization

              4. **Security**
                 - No hardcoded secrets or API keys
                 - Proper environment variable usage
                 - Cookie handling security
                 - Input validation
                 - XSS/injection prevention

              5. **Performance**
                 - Efficient async operations
                 - Proper caching strategies
                 - Resource cleanup (browser contexts)
                 - Rate limiting considerations

              6. **Logging & Error Handling**
                 - Pino structured logging usage
                 - Comprehensive error catching
                 - Meaningful error messages
                 - No console.log usage

              7. **Documentation**
                 - JSDoc comments for complex functions
                 - README updates if needed
                 - Code comments for non-obvious logic

              **Guidelines:**
              - Follow patterns in CLAUDE.md
              - Provide specific line-by-line feedback
              - Suggest concrete improvements
              - Flag critical issues vs nice-to-haves
              - Consider the project context (browser automation + CAPTCHA solving)

              **Output Format:**
              - Use clear severity markers (üî¥ Critical, üü° Warning, üü¢ Suggestion)
              - Include file paths and line numbers
              - Provide code examples for suggested fixes
              """

              try:
                  task = agent.run(prompt=prompt)
                  logger.info("‚úÖ Review task submitted")

                  # Wait for completion (max 10 minutes for thorough review)
                  max_attempts = 60
                  attempt = 0

                  while attempt < max_attempts:
                      task.refresh()
                      status = task.status
                      logger.info(f"üìä Status: {status} ({attempt + 1}/{max_attempts})")

                      if status == "completed":
                          logger.info("‚úÖ Review completed successfully!")

                          if hasattr(task, 'result') and task.result:
                              print(f"\n{'='*80}")
                              print("üìä CODEGEN REVIEW RESULTS")
                              print(f"{'='*80}\n")
                              print(task.result)
                              print(f"\n{'='*80}\n")

                          if hasattr(task, 'web_url') and task.web_url:
                              logger.info(f"üîó View full details: {task.web_url}")

                          break

                      elif status == "failed":
                          logger.error("‚ùå Review failed")
                          if hasattr(task, 'result'):
                              logger.error(f"Error details: {task.result}")
                          sys.exit(1)

                      attempt += 1
                      time.sleep(10)

                  if attempt >= max_attempts:
                      logger.error("‚è∞ Review timed out after 10 minutes")
                      sys.exit(1)

              except Exception as e:
                  logger.error(f"‚ùå Error running Codegen review: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

